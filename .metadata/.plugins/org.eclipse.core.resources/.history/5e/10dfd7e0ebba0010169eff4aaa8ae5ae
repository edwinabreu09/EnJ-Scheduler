package controller;

import dao.ScheduleRepository;
import dao.PatientRepository;
import dao.PhysicianRepository;
import model.Schedule;
import model.Physician;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@CrossOrigin(origins = "http://localhost:3000")
@RequestMapping("/api")
public class ScheduleController {

    private final ScheduleRepository scheduleRepository;
    private final PatientRepository patientRepository;
    private final PhysicianRepository physicianRepository;

    public ScheduleController(ScheduleRepository scheduleRepository, PatientRepository patientRepository, PhysicianRepository physicianRepository) {
        this.scheduleRepository = scheduleRepository;
        this.patientRepository = patientRepository;
        this.physicianRepository = physicianRepository;
    }

    @GetMapping("/schedule")
    public List<Schedule> getAllSchedules() {
        return scheduleRepository.findAll();
    }

    @GetMapping("/schedule/physician/{physicianId}")
    public List<Schedule> getScheduleByPhysician(@PathVariable Long physicianId) {
        return scheduleRepository.findAll()
                .stream()
                .filter(s -> s.getPhysician() != null && s.getPhysician().getId().equals(physicianId))
                .toList();
    }

    @PostMapping("/schedule")
    public Schedule addSchedule(@RequestBody Schedule schedule) {
        if (schedule.getPhysician() != null && schedule.getPhysician().getId() != null) {
            Physician physician = physicianRepository.findById(schedule.getPhysician().getId()).orElse(null);
            schedule.setPhysician(physician);
        }
        return scheduleRepository.save(schedule);
    }

    @PutMapping("/schedule/{id}")
    public Schedule updateSchedule(@PathVariable Integer id, @RequestBody Schedule updatedSchedule) {
        return scheduleRepository.findById(id).map(s -> {
            if (updatedSchedule.getPhysician() != null && updatedSchedule.getPhysician().getId() != null) {
                Physician physician = physicianRepository.findById(updatedSchedule.getPhysician().getId()).orElse(null);
                s.setPhysician(physician);
            }
            s.setPatientId(updatedSchedule.getPatientId());
            s.setDay(updatedSchedule.getDay());
            s.setTime(updatedSchedule.getTime());
            return scheduleRepository.save(s);
        }).orElseGet(() -> {
            updatedSchedule.setId(id);
            return scheduleRepository.save(updatedSchedule);
        });
    }

    @DeleteMapping("/schedule/{id}")
    public void deleteSchedule(@PathVariable Long id) {
        scheduleRepository.deleteById(id);
    }
}
