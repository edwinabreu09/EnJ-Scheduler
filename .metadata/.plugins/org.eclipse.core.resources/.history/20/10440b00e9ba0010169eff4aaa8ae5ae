package controller;

import dao.ScheduleRepository;
import dao.PatientRepository;
import dao.PhysicianRepository;
import model.Schedule;
import model.Patient;
import model.Physician;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@CrossOrigin(origins = "http://localhost:3000")
@RequestMapping("/api")
public class ScheduleController {

    private final ScheduleRepository scheduleRepository;
    private final PatientRepository patientRepository;
    private final PhysicianRepository physicianRepository;

    public ScheduleController(ScheduleRepository scheduleRepository,
                              PatientRepository patientRepository,
                              PhysicianRepository physicianRepository) {
        this.scheduleRepository = scheduleRepository;
        this.patientRepository = patientRepository;
        this.physicianRepository = physicianRepository;
    }

    // ------------------ GET ------------------
    @GetMapping("/schedule")
    public List<Schedule> getAllSchedules() {
        return scheduleRepository.findAll();
    }

    @GetMapping("/schedule/physician/{physicianId}")
    public List<Schedule> getScheduleByPhysician(@PathVariable int physicianId) {
        Physician physician = physicianRepository.findById(physicianId)
                .orElseThrow(() -> new RuntimeException("Physician not found"));
        return scheduleRepository.findByPhysician(physician);
    }

    // ------------------ POST ------------------
    @PostMapping("/schedule")
    public Schedule addSchedule(@RequestBody Schedule schedule) {
        // Fetch full Physician and Patient from DB
        if (schedule.getPhysician() != null) {
            Physician physician = physicianRepository.findById(schedule.getPhysician().getId())
                    .orElseThrow(() -> new RuntimeException("Physician not found"));
            schedule.setPhysician(physician);
        }

        if (schedule.getPatient() != null) {
            Patient patient = patientRepository.findById(schedule.getPatient().getId())
                    .orElseThrow(() -> new RuntimeException("Patient not found"));
            schedule.setPatient(patient);
        }

        return scheduleRepository.save(schedule);
    }

    // ------------------ PUT ------------------
    @PutMapping("/schedule/{id}")
    public Schedule updateSchedule(@PathVariable int id, @RequestBody Schedule updatedSchedule) {
        return scheduleRepository.findById(id).map(s -> {
            if (updatedSchedule.getPhysician() != null) {
                Physician physician = physicianRepository.findById(updatedSchedule.getPhysician().getId())
                        .orElseThrow(() -> new RuntimeException("Physician not found"));
                s.setPhysician(physician);
            }

            if (updatedSchedule.getPatient() != null) {
                Patient patient = patientRepository.findById(updatedSchedule.getPatient().getId())
                        .orElseThrow(() -> new RuntimeException("Patient not found"));
                s.setPatient(patient);
            }

            s.setDay(updatedSchedule.getDay());
            s.setTime(updatedSchedule.getTime());
            return scheduleRepository.save(s);
        }).orElseGet(() -> {
            updatedSchedule.setId(id);
            return scheduleRepository.save(updatedSchedule);
        });
    }

    // ------------------ DELETE ------------------
    @DeleteMapping("/schedule/{id}")
    public void deleteSchedule(@PathVariable int id) {
        scheduleRepository.deleteById(id);
    }
}
